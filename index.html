<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer in a Box</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1a472a">
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="logo">‚öΩ Soccer in a Box</div>
            <div class="mode-switcher">
                <button class="mode-btn active" data-mode="coach">üëî Coach</button>
                <button class="mode-btn" data-mode="detective">üïµÔ∏è Detective</button>
            </div>
        </div>
    </header>

    <!-- CONTAINER PRINCIPALE -->
    <div class="main-container">
        
        
        <!-- COACH MODE -->
        <div id="coach-mode" class="mode-container active">
            <div class="dashboard-grid">
                <div class="card">
                    <h3 class="card-title">üéØ Analisi Live</h3>
                    <div class="card-content">
                        <p>Sistema di tracciamento eventi in tempo reale con classificazione automatica delle azioni.</p>
                        <button class="btn" onclick="startAnalysis()">üöÄ Avvia Analisi</button>
                        <button class="btn secondary" onclick="exportSnapshot()">üì§ Esporta Snapshot</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">üìä Metriche Avanzate</h3>
                    <div class="card-content">
                        <p>xG, passaggi progressivi, pressing intensity e heat maps situazionali.</p>
                        <button class="btn secondary">Visualizza Dati</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="card-title">üß† APES Integration</h3>
                    <div class="card-content">
                        <p>Collegamento diretto con il sistema di scouting cognitivo per profili giocatori.</p>
                        <button class="btn secondary">Sincronizza APES</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üîó Condivisione Snapshot</h3>
                    <div class="card-content">
                        <p>Genera link condivisibili per fan e analisti. Ogni snapshot √® autonomo e offline.</p>
                        <div id="share-link-container" class="hidden" style="margin-top: 1rem;">
                            <input type="text" id="share-link" readonly class="share-input">
                            <button class="btn secondary" onclick="copyShareLink()" style="margin-top: 0.5rem;">üìã Copia Link</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CAMPO DA GIOCO -->
            <div class="field-container">
                <div class="field" id="tactical-field">
                    <!-- Aree di rigore -->
                    <div class="field-left-box"></div>
                    <div class="field-right-box"></div>
                    
                    <!-- Aree piccole -->
                    <div class="field-left-small"></div>
                    <div class="field-right-small"></div>
                    
                    <!-- Punti del rigore -->
                    <div class="penalty-left"></div>
                    <div class="penalty-right"></div>
                </div>
            </div>
        </div>

        <!-- DETECTIVE MODE -->
        <div id="detective-mode" class="mode-container">
            
            <!-- IMPORTAZIONE SNAPSHOT -->
            <div class="import-container" id="import-container">
                <h3>üïµÔ∏è Importa Snapshot Partita</h3>
                <p>Incolla il link condiviso dal coach o carica un file JSON</p>
                <input type="text" id="snapshot-link" class="import-input" 
                       placeholder="soccer://snapshot/JUV-INT-75min-abc123xyz...">
                <div class="import-buttons">
                    <button class="btn" onclick="importFromLink()">üîó Importa da Link</button>
                    <button class="btn secondary" onclick="loadSampleData()">üéÆ Carica Demo</button>
                </div>
                <div class="import-help">
                    Oppure trascina qui un file .json
                </div>
            </div>

            <!-- STATS FAN -->
            <div class="fan-stats" id="fan-stats">
                <div class="stat-item">
                    <div class="stat-value" id="fan-level">1</div>
                    <div class="stat-label">Livello</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fan-points">0</div>
                    <div class="stat-label">Punti</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="predictions-correct">0</div>
                    <div class="stat-label">Predizioni ‚úì</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="narratives-written">0</div>
                    <div class="stat-label">Cronache</div>
                </div>
            </div>

            <!-- BADGES -->
            <div class="card">
                <h3 class="card-title">üèÜ I Tuoi Badge</h3>
                <div class="badges-container" id="badges-container">
                    <div class="badge">üÜï Rookie Detective</div>
                </div>
            </div>

            <!-- AREA INVESTIGAZIONE -->
            <div id="investigation-area" class="hidden">
                
                <!-- EVENTO MISTERIOSO -->
                <div class="mystery-event" id="current-mystery">
                    <div class="event-time" id="mystery-time">65'</div>
                    <div class="mystery-text" id="mystery-description">
                        üîç Chiesa riceve palla sulla fascia destra...
                    </div>
                    
                    <div class="prediction-options" id="prediction-options">
                        <!-- Popolato dinamicamente -->
                    </div>
                    
                    <div class="mt-1">
                        <button class="btn" onclick="submitPrediction()" id="submit-prediction">üîÆ Conferma Predizione</button>
                    </div>
                </div>

                <!-- RISULTATO PREDIZIONE -->
                <div class="card hidden" id="prediction-result">
                    <h3 class="card-title">üé≠ La Rivelazione</h3>
                    <div class="card-content" id="revelation-content">
                        <!-- Popolato dinamicamente -->
                    </div>
                    <button class="btn" onclick="nextMystery()">üîç Prossimo Mistero</button>
                </div>

                <!-- MODALIT√Ä NARRATIVA -->
                <div class="card" id="narrative-mode">
                    <h3 class="card-title">üìù Scrivi la Cronaca</h3>
                    <div class="card-content">
                        <p>Descrivi quello che √® appena successo come un giornalista sportivo:</p>
                        <textarea class="narrative-input" id="user-narrative" 
                                  placeholder="Al 67¬∞ minuto, Chiesa riceve il pallone sulla destra e..."></textarea>
                        <button class="btn" onclick="submitNarrative()">üì∞ Pubblica Cronaca</button>
                        
                        <div class="narrative-comparison hidden" id="narrative-comparison">
                            <div class="narrative-box">
                                <h4>üìù La Tua Cronaca</h4>
                                <div id="user-narrative-display"></div>
                            </div>
                            <div class="narrative-box">
                                <h4>üéØ Cronaca Ufficiale</h4>
                                <div id="official-narrative"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PROGRESSIONE -->
                <div class="card">
                    <h3 class="card-title">üìà Progressione Partita</h3>
                    <div class="card-content">
                        <div class="progress-header">
                            <span>Progresso Analisi</span>
                            <span id="progress-text">0/0 eventi analizzati</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION SYSTEM -->
    <div id="notification" class="notification"></div>

    <script src="app.js" defer></script>

    <!-- JAVASCRIPT COMPLETO INLINE -->
    <script>
        // ===== SOCCER IN A BOX - MAIN CLASS =====
        class SoccerInABox {
            constructor() {
                this.currentMode = 'coach';
                this.fanProfile = {
                    level: 1,
                    points: 0,
                    predictionsCorrect: 0,
                    narrativesWritten: 0,
                    badges: ['üÜï Rookie Detective']
                };
                this.currentSnapshot = null;
                this.mysteryIndex = 0;
                this.currentPrediction = null;
                this.mysteries = [];
                this.init();
            }

            init() {
                this.setupModeNavigation();
                this.setupImportSystem();
                this.loadFanProfile();
            }

            // ===== NAVIGAZIONE =====
            setupModeNavigation() {
                const modeButtons = document.querySelectorAll('.mode-btn');
                const modeContainers = document.querySelectorAll('.mode-container');

                modeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetMode = btn.dataset.mode;
                        
                        modeButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        modeContainers.forEach(container => {
                            container.classList.remove('active');
                        });
                        
                        document.getElementById(`${targetMode}-mode`).classList.add('active');
                        this.currentMode = targetMode;
                        this.showNotification(`Modalit√† ${targetMode} attivata!`);
                    });
                });
            }

            // ===== EXPORT SNAPSHOT =====
            exportSnapshot() {
                const snapshot = {
                    match: "Juventus vs Inter",
                    timestamp: "75'",
                    score: "2-1",
                    mysteries: [
                        {
                            time: "65'",
                            setup: "Chiesa riceve palla sulla fascia destra, a 25 metri dalla porta avversaria. Davanti a lui Bastoni in marcatura, alle spalle Vlahovic che chiede palla in area...",
                            question: "Cosa succeder√† secondo te?",
                            options: [
                                { id: "cross", text: "üéØ Cross in area per Vlahovic", correct: true },
                                { id: "dribbling", text: "‚ö° Dribbling su Bastoni", correct: false },
                                { id: "backward", text: "‚Ü©Ô∏è Passaggio indietro sicuro", correct: false },
                                { id: "shot", text: "üöÄ Tiro dalla distanza", correct: false }
                            ],
                            revelation: "‚öΩ Chiesa crossa perfettamente in area! Vlahovic svetta di testa ma Handanovic para in extremis!",
                            points: 50
                        }
                    ]
                };

                const encoded = btoa(JSON.stringify(snapshot));
                const shareLink = `soccer://snapshot/${encoded}`;
                
                document.getElementById('share-link').value = shareLink;
                document.getElementById('share-link-container').classList.remove('hidden');
                
                this.showNotification('üîó Link snapshot generato!', 'success');
            }

            // ===== IMPORT =====
            setupImportSystem() {
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('prediction-btn')) {
                        document.querySelectorAll('.prediction-btn').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        e.target.classList.add('selected');
                        this.currentPrediction = e.target.dataset.option;
                    }
                });
            }

            importFromLink() {
                const link = document.getElementById('snapshot-link').value.trim();
                
                if (!link.startsWith('soccer://snapshot/')) {
                    this.showNotification('‚ùå Link non valido', 'error');
                    return;
                }
                
                try {
                    const encoded = link.replace('soccer://snapshot/', '');
                    const snapshot = JSON.parse(atob(encoded));
                    this.loadSnapshot(snapshot);
                } catch (error) {
                    this.showNotification('‚ùå Errore nel decodificare il link', 'error');
                }
            }

            loadSampleData() {
                this.exportSnapshot();
                const link = document.getElementById('share-link').value;
                document.getElementById('snapshot-link').value = link;
                this.importFromLink();
            }

            loadSnapshot(snapshot) {
                this.currentSnapshot = snapshot;
                this.mysteries = snapshot.mysteries || [];
                this.mysteryIndex = 0;
                
                document.getElementById('import-container').classList.add('hidden');
                document.getElementById('investigation-area').classList.remove('hidden');
                
                this.loadCurrentMystery();
                this.showNotification(`üïµÔ∏è Analisi caricata: ${snapshot.match}`, 'success');
            }

            // ===== DETECTIVE GAMEPLAY =====
            loadCurrentMystery() {
                if (this.mysteryIndex >= this.mysteries.length) {
                    this.completeInvestigation();
                    return;
                }

                const mystery = this.mysteries[this.mysteryIndex];
                
                document.getElementById('prediction-result').classList.add('hidden');
                document.getElementById('current-mystery').classList.remove('hidden');
                
                document.getElementById('mystery-time').textContent = mystery.time;
                document.getElementById('mystery-description').innerHTML = 
                    mystery.setup + '<br><br><strong>' + mystery.question + '</strong>';
                
                const optionsContainer = document.getElementById('prediction-options');
                optionsContainer.innerHTML = '';
                
                mystery.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'prediction-btn';
                    btn.dataset.option = option.id;
                    btn.textContent = option.text;
                    optionsContainer.appendChild(btn);
                });

                this.currentPrediction = null;
                this.updateProgress();
            }

            submitPrediction() {
                if (!this.currentPrediction) {
                    this.showNotification('ü§î Seleziona prima una predizione!', 'info');
                    return;
                }

                const mystery = this.mysteries[this.mysteryIndex];
                const selectedOption = mystery.options.find(opt => opt.id === this.currentPrediction);
                const isCorrect = selectedOption.correct;
                
                document.querySelectorAll('.prediction-btn').forEach(btn => {
                    const optionData = mystery.options.find(opt => opt.id === btn.dataset.option);
                    if (optionData.correct) {
                        btn.classList.add('correct');
                    } else if (btn.dataset.option === this.currentPrediction) {
                        btn.classList.add('wrong');
                    }
                });

                if (isCorrect) {
                    this.fanProfile.points += mystery.points;
                    this.fanProfile.predictionsCorrect++;
                }

                this.showRevelation(mystery, isCorrect);
                this.updateFanStats();
                this.saveFanProfile();
            }

            showRevelation(mystery, isCorrect) {
                const resultCard = document.getElementById('prediction-result');
                const content = document.getElementById('revelation-content');
                
                const pointsText = isCorrect ? 
                    `<div style="color: #22c55e; font-weight: bold;">+${mystery.points} punti! üéâ</div>` :
                    `<div style="color: #ef4444;">Nessun punto questa volta üòî</div>`;
                
                content.innerHTML = `
                    <div style="font-size: 1.1rem; margin-bottom: 1rem;">
                        ${mystery.revelation}
                    </div>
                    ${pointsText}
                `;
                
                document.getElementById('current-mystery').classList.add('hidden');
                resultCard.classList.remove('hidden');
            }

            nextMystery() {
                this.mysteryIndex++;
                this.loadCurrentMystery();
            }

            // ===== GAMIFICATION =====
            updateFanStats() {
                document.getElementById('fan-level').textContent = this.fanProfile.level;
                document.getElementById('fan-points').textContent = this.fanProfile.points;
                document.getElementById('predictions-correct').textContent = this.fanProfile.predictionsCorrect;
                document.getElementById('narratives-written').textContent = this.fanProfile.narrativesWritten;
                
                const newLevel = Math.floor(this.fanProfile.points / 100) + 1;
                if (newLevel > this.fanProfile.level) {
                    this.fanProfile.level = newLevel;
                    this.showNotification(`üÜô Level UP! Ora sei livello ${newLevel}!`, 'success');
                }
            }

            updateProgress() {
                const progress = ((this.mysteryIndex) / this.mysteries.length) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = 
                    `${this.mysteryIndex}/${this.mysteries.length} eventi analizzati`;
            }

            // ===== 